<link rel="import" href="/bower_components/polymer/polymer-element.html">

<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">

<link rel="import" href="/bower_components/vaadin-text-field/theme/lumo/vaadin-password-field.html">
<link rel="import" href="./../aspen-dialog/aspen-dialog-mixin.html">


<dom-module id="aspen-password-dialog">
    <template>
        <style>
            :host {
                display: block
            }

            paper-button {
                background-color: var(--app-header-color);
                color: white;
                width: fit-content;
            }

            label {
                font-size: 0.9em;
                color: red;
            }
        </style>


        <paper-dialog>
            <h2>Change Password</h2>

            <vaadin-password-field label="Password" value="{{password}}" required autofocus type="password">
            </vaadin-password-field>
            <label>[[msg]]</label>

            <div class="buttons">

                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm autofocus on-tap="__changePassword">Accept</paper-button>

            </div>
        </paper-dialog>


    </template>

    <script>
        /**
         * `aspen-password-dialog` This dialog allows the user to change the password.
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class AspPasswordDialog extends AspDialogMixin(Polymer.Element) {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'aspen-password-dialog';
            }

            /**
             * Object describing property-related metadata used by Polymer features
             */
            static get properties() {
                return {

                    /** The firebase user object. */
                    user: {
                        type: Object,
                        value: null
                    },

                    /** The new password. */
                    password: {
                        type: String,
                        value: ''
                    },

                    /** The text of the error message. */
                    msg: {
                        type: String,
                        value: ''
                    }

                };
            }

            /**
             * Instance of the element is created/upgraded. Use: initializing state,
             * set up event listeners, create shadow dom.
             * @constructor
             */
            constructor() {
                super();
            }

            /**
             * Use for one-time configuration of your component after local DOM is initialized. 
             */
            ready() {
                super.ready();

                Polymer.RenderStatus.afterNextRender(this, function () {

                });
            }

            __changePassword() {
                let successMsg = "";
                this.user.updatePassword(this.password)
                    .then(success => {
                        successMsg = "Password updated";
                    })
                    .catch(error => {
                        if (error.code == 'auth/weak-password') {
                            this.msg = 'The password is too weak.';
                        }
                    });

                if (successMsg) {
                    this.dispatchEvent(new CustomEvent('show-msg', {
                        bubbles: true,
                        composed: true,
                        detail: {
                            msg: successMsg
                        }
                    }));
                }

            }

        }

        window.customElements.define(AspPasswordDialog.is, AspPasswordDialog);
    </script>
</dom-module>